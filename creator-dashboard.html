<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creator Dashboard | Art Club</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; }
.navbar { background:#333; color:#fff; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
.navbar a { color:white; margin-left:20px; text-decoration:none; }
.navbar button { background:#00796b; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; color:white; }

.tab-bar { display:flex; background:white; padding:10px; gap:10px; justify-content:center; }
.tab-button { padding:10px 15px; background:#ddd; border-radius:6px; cursor:pointer; }
.tab-button.active { background:#00796b; color:white; }

.tab-content { display:none; max-width:900px; margin:20px auto; background:white; padding:20px; border-radius:10px; }
.tab-content.active { display:block; }

table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #ccc; padding:10px; }
th { background:#eee; }

.search-box { width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:6px; }

button.assign, button.update, button.delete-question { 
    background:#00796b; 
    color:white; 
    padding:5px 10px; 
    border:none; 
    border-radius:6px; 
    cursor:pointer; 
}
button.delete-question { background:#b71c1c; }
</style>
</head>
<body>

<header class="navbar">
  <h1>Creator Dashboard</h1>
  <div>
    <a href="index.html">Home</a>
    <button id="logout-btn">Logout</button>
  </div>
</header>

<div class="tab-bar">
    <div class="tab-button active" data-tab="manage">Manage Users</div>
    <div class="tab-button" data-tab="allusers">All Users</div>
    <div class="tab-button" data-tab="questions">Questions</div>
</div>

<section id="manage" class="tab-content active">
<h2>Manage Users</h2>
<table id="users-table">
<thead>
<tr>
<th>Username</th>
<th>Rank</th>
<th>Assign Rank</th>
<th>Change Password</th>
</tr>
</thead>
<tbody></tbody>
</table>
</section>

<section id="allusers" class="tab-content">
<h2>All Users</h2>
<input type="text" id="user-search" class="search-box" placeholder="Search users...">
<table id="all-users-table">
<thead>
<tr>
<th>Username</th>
<th>Rank</th>
</tr>
</thead>
<tbody></tbody>
</table>
</section>

<section id="questions" class="tab-content">
<h2>Submitted Questions</h2>
<input type="text" id="question-search" class="search-box" placeholder="Search questions...">
<table id="question-table">
<thead>
<tr>
<th>Name</th>
<th>Question</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</section>

<script>
// ------------------ PROTECT PAGE ------------------
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser || currentUser.rank !== "creator") {
    alert("Access denied!");
    window.location.href = "index.html";
}

// ------------------ LOGOUT ------------------
document.getElementById("logout-btn").addEventListener("click", () => {
    localStorage.removeItem("currentUser");
    window.location.href = "login.html";
});

// ------------------ TAB SYSTEM ------------------
document.querySelectorAll(".tab-button").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));

        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
    });
});

// ------------------ USERS API ------------------
async function fetchUsers() {
    const res = await fetch("/api/users");
    return await res.json();
}

async function updateUser(user) {
    await fetch("/api/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(user)
    });
}

async function renderManageUsers() {
    const users = await fetchUsers();
    const tbody = document.querySelector("#users-table tbody");
    tbody.innerHTML = "";
    users.forEach((user, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${user.username}</td>
            <td>${user.rank}</td>
            <td>
                <select id="rank-${index}">
                    <option value="member" ${user.rank==="member"?"selected":""}>Member</option>
                    <option value="creator" ${user.rank==="creator"?"selected":""}>Creator</option>
                    <option value="admin" ${user.rank==="admin"?"selected":""}>Admin</option>
                </select>
                <button class="assign" data-index="${index}">Assign</button>
            </td>
            <td>
                <input type="password" id="pass-${index}" placeholder="New password">
                <button class="update" data-index="${index}">Update</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    tbody.addEventListener("click", async e => {
        const idx = e.target.dataset.index;
        if (e.target.classList.contains("assign")) {
            const users = await fetchUsers();
            users[idx].rank = document.getElementById(`rank-${idx}`).value;
            await updateUser(users[idx]);
            alert("Rank updated!");
            renderManageUsers();
        }
        if (e.target.classList.contains("update")) {
            const newPass = document.getElementById(`pass-${idx}`).value.trim();
            if(!newPass) return alert("Password cannot be empty.");
            const users = await fetchUsers();
            users[idx].password = newPass;
            await updateUser(users[idx]);
            alert("Password updated!");
            renderManageUsers();
        }
    });
}

renderManageUsers();

// ------------------ ALL USERS ------------------
async function renderAllUsers(filter="") {
    const users = await fetchUsers();
    const tbody = document.querySelector("#all-users-table tbody");
    tbody.innerHTML = "";
    users
        .filter(u => u.username.toLowerCase().includes(filter.toLowerCase()))
        .forEach(u => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${u.username}</td><td>${u.rank}</td>`;
            tbody.appendChild(tr);
        });
}

document.getElementById("user-search").addEventListener("input", e => {
    renderAllUsers(e.target.value);
});

renderAllUsers();

// ------------------ QUESTIONS ------------------
async function fetchQuestions() {
    const res = await fetch("/api/questions");
    return await res.json();
}

async function deleteQuestion(index) {
    await fetch(`/api/questions/${index}`, { method: "DELETE" });
}

async function renderQuestions(filter="") {
    const questions = await fetchQuestions();
    const tbody = document.querySelector("#question-table tbody");
    tbody.innerHTML = "";
    questions
        .filter(q => q.name.toLowerCase().includes(filter.toLowerCase()) || q.text.toLowerCase().includes(filter.toLowerCase()))
        .forEach((q, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${q.name}</td><td>${q.text}</td><td><button class="delete-question" data-index="${index}">Delete</button></td>`;
            tbody.appendChild(tr);
        });

    tbody.querySelectorAll(".delete-question").forEach(btn => {
        btn.addEventListener("click", async e => {
            await deleteQuestion(e.target.dataset.index);
            renderQuestions(filter);
        });
    });
}

document.getElementById("question-search").addEventListener("input", e => {
    renderQuestions(e.target.value);
});

renderQuestions();
</script>

</body>
</html>
